<!DOCTYPE html>
<html>
<head>
    <title>Historic Landmarks</title>       
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <script src="https://maps.google.com/maps/api/js?sensor=true"></script>
    <link rel="stylesheet" href="geolocation.css" />
    <link rel="stylesheet" href="gmap_api.css" />
    <script>
        var lat = 0;
        var lng = 0;
        var xhr = new XMLHttpRequest();
        var me  = new google.maps.LatLng(lat, lng);
        var myOptions = {
            zoom: 13,
            center: me,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        var map;                       
        var marker_people;
        var marker_landmarks;
        var infowindow = new google.maps.InfoWindow();

        function init()
        {
            map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
            getMyLocation();
        }

        function getMyLocation() {

            function success(crd) {
                lat = crd.coords.latitude;
                lng = crd.coords.longitude;
                displayMap();
            };

            function error(err) {
                console.warn(`ERROR(${err.code}): ${err.message}`);
            };

            navigator.geolocation.getCurrentPosition(success, error);
        }

        function displayMap() {

            me = new google.maps.LatLng(lat, lng);
            map.panTo(me);
            
            marker_people = new google.maps.Marker({
                position: me,
                title: "Here I Am"
            });
            marker_people.setMap(map);
            
            loadLocationsNearMe();
            
            google.maps.event.addListener(marker_people, 'click', function() {
                infowindow.setContent(marker_people.title);
                infowindow.open(map, marker_people);
            });
        }

        function loadLocationsNearMe() {
            xhr.open("POST", "https://defense-in-derpth.herokuapp.com/sendLocation", true);
            xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            xhr.onreadystatechange = function() {
                
                if (xhr.readyState == 4 && xhr.status == 200) {
                    rawData = xhr.responseText;
                    data    = JSON.parse(rawData);
                    console.log("here");
                    for (count = 0; count < data.people.length; count++) {
                        pos = new google.maps.LatLng(data.people[count].lat, data.people[count].lng);
                        marker_people = new google.maps.Marker({
                            position: pos,
                            title: data.people[count].login
                        });
                        marker_people.setMap(map);
                    }
                }
                xhr.send("login=SrmNO5wg&lat=" + lat + "&lng=" + lng);
            }
        }
    </script>
</head>
        
<body onload="init()">
    <div id="data"></div>
    <div id="map_canvas"></div>
    <!--<div id="location"></div>-->
</body>
</html>